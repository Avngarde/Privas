@page "/"
@inject ProtectedLocalStorage localStorage
@inject NavigationManager NavManager
@using Privas.SupportClasses
@using Privas.Connectors
@inject IToastService toastService

<PageTitle>Index</PageTitle>

<div id="index_container">
    <div id="first_half">
        <span id="app_name">PRIVAS</span>
        <span id="app_description">Website for private, quick chats</span>
    </div>
    <div id="second_half">
       <div id="second_half_content">
           <div id="username_form">
               <input type="text" placeholder="Username" @bind="username" />
               <button @onclick="SetUsername">Set username</button>
           </div>
           <span>And then</span>
           <div id="index_options_holder">
               <a href="" @onclick="GoToChatrooms">Browse roomchats</a>
               <span>Or</span>
               <a href="" @onclick="GoToAddChatroom">Create a roomchat</a>
           </div>
       </div> 
    </div>
</div>

@code {
    private string? username;

    private async Task SetUsername()
    {
        if (username != null) 
        {
            var userCode = await localStorage.GetAsync<string>("privas_currentUserCode");
            if (userCode.Value != null)
            {
                toastService.ShowInfo("Deleting old messages, and owned chatrooms to create new user session...", "User session already exists");
                MembershipConnector membershipConnector = new();
                ChatroomConnector chatroomConnector = new();
                await localStorage.DeleteAsync("privas_currentUserName");
                await localStorage.DeleteAsync("privas_currentUserCode");
                await membershipConnector.Delete(userCode.Value);
                await chatroomConnector.DeleteByUserCode(userCode.Value);
            }
            await localStorage.SetAsync("privas_currentUserName", username);
            await localStorage.SetAsync("privas_currentUserCode", UserCodeGenerator.Generate());
            toastService.ShowSuccess("", "Username set");
        }
    }

    private async Task GoToChatrooms() 
    {
        var username = await localStorage.GetAsync<string>("privas_currentUserName");
        var userCode = await localStorage.GetAsync<string>("privas_currentUserCode");
        if (username.Value != null && userCode.Value != null) 
        {
            NavManager.NavigateTo("/chatrooms");
        }
    }

    private async Task GoToAddChatroom()
    {
        var username = await localStorage.GetAsync<string>("privas_currentUserName");
        var userCode = await localStorage.GetAsync<string>("privas_currentUserCode");
        if (username.Value != null && userCode.Value != null) 
        {
            NavManager.NavigateTo("/addchatroom");
        }   
    }
}